#!/bin/bash

function usage() {
    cat <<EOF
usage: $(basename $0) [-m <message>] <commit>
  This command must be run from a branch.
EOF
    exit 1
}

branch="$(git branch-name)"
while getopts ':m:' option; do
    case "$option" in
        m)
            message="$OPTARG"
            ;;
        *)
            usage
    esac
done
shift "$((OPTIND-1))"

merge_branch="$1"
message="${message-Merge branch '$branch' into '$merge_branch'}"

if [[ "$branch" && "$merge_branch" && "$message" ]]; then
    incoming_count="$(git log --oneline ..$merge_branch | wc -l)"
    if [[ "$incoming_count" -gt 0 ]]; then
        colorize git checkout "$merge_branch"
        if colorize git merge --no-ff -m "$message" "$branch"; then
            git local-push "$branch"
        else
            echo -e "When complete, run:"
            echo -e "git local-push '$branch'"
            exit 1
        fi
    else
        echo -e "$merge_branch has no incoming changes for this branch. Perhaps you need to fetch?"
        exit 1
    fi
else
    usage
fi
